import pandas as pd

configfile: "config/config.yaml"

samples = pd.read_csv(config["samples"], sep = "\t").set_index("sample", drop=False)

def get_path(wildcards):
    return samples.loc[wildcards.sample, 'path']


rule all:
	input:
			expand("results/sniffles/{sample}.vcf",zip, sample=samples['sample'])
rule guppy:
	input:
			get_path
	output: 
			directory("results/guppy/{sample}")
	benchmark: 
			"benchmarks/{sample}.tsv"
	threads:
			8
	resources: 
			mem_mb= 32000,
			runtime= 1440   
	shell:
			"resources/ont-guppy/bin/guppy_basecaller --model_file template_r9.4.1_450bps_hac.jsn --save_path {output} --input_path {input} --device cuda:all:100% --disable_pings -c dna_r9.4.1_450bps_fast.cfg --min_qscore 7 --recursive -x 'cuda:all' --num_callers 4 --gpu_runners_per_device 4 --chunks_per_runner 1024 --chunk_size 1000 --compress_fastq"

rule nanoplot:
	input: 
			"results/guppy/{sample}"
	output:
			directory("results/nanoplot/{sample}")
	benchmark: "benchmarks/{sample}.tsv"
	threads: 
			8
	resources: 
			mem_mb= 32000,
			runtime= 1440
	conda:
			"envs/nanoplot.yaml"   
	shell: 
			"NanoPlot --summary {input}/sequencing_summary.txt --loglength -o {output}"

rule concat:
	input: 
			"results/guppy/{sample}"
	output:
			"{sample}_fastq.gz"
	benchmark: "benchmarks/{sample}.tsv"
	threads: 
			8
	resources: 
			mem_mb= 32000,
			runtime= 1440     
	shell:
			"cat {input}/pass/*.fastq.gz > {output}"
			
rule minimap2:
	input: 
			fastq="{sample}_fastq.gz",
			genome="resources/GRCh38.primary_assembly.genome.fa.gz"
	output:
			"results/minimap/{sample}.sam"
	params:
			extra="-a -x map-ont"
	benchmark: "benchmarks/{sample}.tsv"
	threads: 
			8
	resources: 
			mem_mb= 32000,
			runtime= 1440
	conda:
			"envs/minimap2.yaml"     
	shell: 
			"minimap2 {input.genome} {input.fastq} > {output}"

rule samtools_conversion_to_bam:
	input:
			"results/minimap/{sample}.sam"
	output:
			"results/samtools/{sample}.bam"
	benchmark: "benchmarks/{sample}.tsv"
	threads: 
			8
	resources: 
			mem_mb= 32000,
			runtime= 1440
	conda:
			"envs/samtools.yaml"      
	shell:
			"samtools view -bo {input} {output}"

rule samtools_sort:
    input:
        	"results/samtools/{sample}.bam"
    output:
        	"results/sorted/{sample}.sorted.bam"
    benchmark: "benchmarks/{sample}.tsv"
	threads: 
			8
	resources: 
			mem_mb= 32000,
			runtime= 1440
	conda:
			"envs/samtools.yaml"
	shell:
			"samtools sort -o {output} {input}"

rule samtools_index:
    input:
        	"results/sorted/{sample}.sorted.bam"
    output:
        	"results/samtools/bai/{sample}.sorted.bam.bai"
    benchmark: "benchmarks/{sample}.tsv"
	threads: 
			8
	resources: 
			mem_mb= 32000,
			runtime= 1440   
	conda:
			"envs/samtools.yaml"
	shell:
        	"samtools index {input}"
rule sniffles:
	input:
			bam="results/sorted/{sample}.sorted.bam",
			bai="results/samtools/bai/{sample}.sorted.bam.bai"
	output:
			"results/sniffles/{sample}.vcf"
	conda:
			"envs/sniffles.yaml"
	benchmark: "benchmarks/{sample}.tsv"
	threads: 
			8
	resources: 
			mem_mb= 32000,
			runtime= 1440   
	shell:
			"sniffles --input {input.bam} --vcf {output}"